<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Prep App & Admin v17</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-font-smoothing: antialiased; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .progress-bar-transition { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        
        const Icons = {
            BookOpen: <g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></g>,
            CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
            XCircle: <g><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></g>,
            ChevronRight: <polyline points="9 18 15 12 9 6"/>,
            RotateCcw: <g><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></g>,
            Award: <g><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></g>,
            Menu: <g><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></g>,
            X: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
            Home: <g><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></g>,
            Glasses: <g><path d="M6 15a2 2 0 1 1 2 2 2 2 0 0 1-2-2z"/><path d="M16 15a2 2 0 1 1 2 2 2 2 0 0 1-2-2z"/><path d="M2.5 13L5 7c.7-1.3 1.4-2 3-2"/><path d="M21.5 13L19 7c-.7-1.3-1.4-2-3-2"/><line x1="8" y1="5" x2="16" y2="5"/></g>,
            PenTool: <g><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></g>,
            ArrowLeft: <g><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></g>,
            Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
            Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
            User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
            LogOut: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>,
            History: <path d="M12 20v-6M6 20V10M18 20V4"/>,
            Library: <g><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></g>,
            Lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></g>,
            LockOpen: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></g>,
            Trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
            Plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
            UpdateDoc: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></g>,
            Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
            Refresh: <g><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></g>,
            Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            Eye: <g><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></g>,
            EyeOff: <g><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></g>,
            UserPlus: <g><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></g>,
            AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
            FilePlus: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></g>,
            Bell: <g><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></g>,
            Check: <g><polyline points="20 6 9 17 4 12"/></g>,
            HelpCircle: <g><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></g>,
            Copy: <g><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></g>,
            Key: <g><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></g>,
            Cloud: <g><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19H19a5 5 0 0 0 5-5c0-2.08-.8-4.083-2.1-5.1"/><path d="M6.5 19H5a5 5 0 0 1-5-5c0-2.65 2-5 4.9-5.1"/><path d="M12 13.5V2"/></g>,
            Edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
            Shield: <g><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></g>,
            Mail: <g><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></g>
        };

        const I = (props) => <Icon path={Icons[props.n]} {...props} />;

        // --- CONSTANTS ---
        const LS_COURSES = 'app_courses';
        const LS_USERS = 'app_users';
        const LS_ACTIVE_USER = 'active_user';
        const LS_GH_URL = 'gh_sync_url';
        const LS_ADMIN_CREDS = 'admin_creds';
        const TIME_PER_QUESTION = 60; // 1 Minute per question

        const sampleCourses = [{ id: "ajo-sample", title: "Adobe Journey Optimizer", description: "Expert Certification Prep (Default)", code: "", hidden: false, modules: [{ id: 1, title: "Module 01: Basics", questions: [{ id: 101, question: "What is AJO?", options: ["CMS", "Journey Tool", "Email Client", "Game"], answer: 1, explanation: "It orchestrates journeys." }] }] }];

        const DEFAULT_ADMIN = { user: 'admin', pass: 'admin', email: '' };

        // --- UTILS ---
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // --- COMPONENTS ---
        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] animate-fade-in backdrop-blur-sm p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh] animate-slide-up">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                        <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                        <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><I n="X" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto">
                        {children}
                    </div>
                </div>
            </div>
        );

        const Notification = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, []);
            const bg = type === 'error' ? 'bg-red-500' : 'bg-emerald-600';
            const icon = type === 'error' ? 'AlertCircle' : 'CheckCircle';
            return (
                <div className={`fixed bottom-6 right-6 ${bg} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up z-[200] max-w-sm`}>
                    <I n={icon} size={24} className="shrink-0"/>
                    <p className="font-medium text-sm">{message}</p>
                    <button onClick={onClose} className="ml-2 hover:opacity-75"><I n="X" size={16}/></button>
                </div>
            );
        };

        const Footer = () => (
            <div className="w-full text-center p-4 text-xs text-slate-400 mt-auto border-t border-slate-100 bg-slate-50">
                &copy; {new Date().getFullYear()} Ramprasad NS. All rights reserved.
            </div>
        );

        const LoginScreen = ({ onLogin, onSignup, onForgotPass }) => {
            const [mode, setMode] = useState('login'); // login or signup
            const [name, setName] = useState("");
            const [pass, setPass] = useState("");
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (mode === 'login') onLogin(name, pass);
                else onSignup(name);
            };

            return (
                <div className="flex h-screen items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full border border-slate-200">
                        <div className="flex justify-center mb-4 text-blue-600"><div className="p-3 bg-blue-50 rounded-full"><I n="User" size={32}/></div></div>
                        <h2 className="text-2xl font-bold text-center mb-2">{mode === 'login' ? 'Login' : 'Create Account'}</h2>
                        
                        <div className="flex bg-slate-100 p-1 rounded-lg mb-6">
                            <button onClick={() => setMode('login')} className={`flex-1 py-1 text-sm font-bold rounded-md transition-colors ${mode === 'login' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}>Login</button>
                            <button onClick={() => setMode('signup')} className={`flex-1 py-1 text-sm font-bold rounded-md transition-colors ${mode === 'signup' ? 'bg-white shadow text-slate-800' : 'text-slate-400'}`}>Sign Up</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="text-xs font-bold text-slate-500 uppercase">Username</label><input value={name} onChange={e => setName(e.target.value)} className="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter name" required /></div>
                            
                            {mode === 'login' && (
                                <div className="animate-fade-in">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Password <span className="font-normal text-slate-300">(Optional for Students)</span></label>
                                    <input type="password" value={pass} onChange={e => setPass(e.target.value)} className="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter password (Admin only)" />
                                    <div className="text-right mt-1">
                                        <button type="button" onClick={onForgotPass} className="text-xs text-blue-500 hover:underline">Forgot Admin Password?</button>
                                    </div>
                                </div>
                            )}
                            
                            <button className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">{mode === 'login' ? 'Enter App' : 'Create Account'}</button>
                        </form>
                    </div>
                    <div className="fixed bottom-4 right-4 text-xs text-slate-400">
                        &copy; {new Date().getFullYear()} Ramprasad NS. All rights reserved.
                    </div>
                </div>
            );
        };

        // --- ADMIN COMPONENT ---
        const AdminPanel = ({ courses, setCourses, users, setUsers, onLogout }) => {
            const [activeTab, setActiveTab] = useState('courses');
            const [newUserName, setNewUserName] = useState('');
            const [newCourseTitle, setNewCourseTitle] = useState('');
            const [newCourseId, setNewCourseId] = useState('');
            const [newCourseDesc, setNewCourseDesc] = useState('');
            
            // ADMIN SETTINGS STATES
            const [adminUser, setAdminUser] = useState('');
            const [adminPass, setAdminPass] = useState('');
            const [adminEmail, setAdminEmail] = useState('');
            
            const bulkInputRef = useRef(null);
            const singleInputRef = useRef(null);
            const questionsInputRef = useRef(null);
            
            const [targetCourseId, setTargetCourseId] = useState(null);
            const [targetModuleId, setTargetModuleId] = useState(null); 

            const [notification, setNotification] = useState(null);
            const [viewingCourse, setViewingCourse] = useState(null);
            const [showPromptModal, setShowPromptModal] = useState(false);
            const [showSyncModal, setShowSyncModal] = useState(false);
            const [ghUrl, setGhUrl] = useState(localStorage.getItem(LS_GH_URL) || '');

            // EDIT USER STATES
            const [editingUserIdx, setEditingUserIdx] = useState(null);
            const [editName, setEditName] = useState("");

            const notify = (msg, type = 'success') => setNotification({ message: msg, type });

            useEffect(() => {
                const creds = JSON.parse(localStorage.getItem(LS_ADMIN_CREDS)) || DEFAULT_ADMIN;
                setAdminUser(creds.user);
                setAdminPass(creds.pass);
                setAdminEmail(creds.email);
            }, []);

            const saveAdminSettings = () => {
                const newCreds = { user: adminUser, pass: adminPass, email: adminEmail };
                localStorage.setItem(LS_ADMIN_CREDS, JSON.stringify(newCreds));
                notify("Admin credentials updated securely.");
            };

            // 1. Bulk Import 
            const handleBulkImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        processImportJson(json);
                    } catch(err) { notify("JSON Error: Check file format.", "error"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const processImportJson = (json) => {
                if (Array.isArray(json)) {
                    const isModuleList = json.length > 0 && json[0].questions && !json[0].modules;
                    if (isModuleList) {
                        const newCourse = {
                            id: "imported-course-" + Date.now(),
                            title: "Imported Course (" + new Date().toLocaleDateString() + ")",
                            description: "Automatically created from bulk module import.",
                            modules: json
                        };
                        setCourses([...courses, newCourse]);
                        notify(`Detected Module List. Wrapped into new course: "${newCourse.title}".`);
                    } else {
                        const newCourses = [...courses];
                        json.forEach(c => {
                            if(!c.modules) return; 
                            const idx = newCourses.findIndex(ex => ex.id === c.id);
                            if (idx >= 0) newCourses[idx] = c;
                            else newCourses.push(c);
                        });
                        setCourses(newCourses);
                        notify(`Success! ${json.length} courses processed.`);
                    }
                } else {
                     notify("Invalid format. File must be an ARRAY.", "error");
                }
            };

            const triggerSingleImport = (id) => {
                setTargetCourseId(id);
                singleInputRef.current.click();
            };

            // 2. Single Import 
            const handleSingleImport = (e) => {
                const file = e.target.files[0];
                if (!file || !targetCourseId) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        const newCourses = [...courses];
                        const idx = newCourses.findIndex(c => c.id === targetCourseId);
                        
                        if (idx !== -1) {
                            if (Array.isArray(json)) {
                                const isModuleList = json.length > 0 && json[0].questions;
                                if (isModuleList) {
                                    newCourses[idx] = { ...newCourses[idx], modules: json };
                                    setCourses(newCourses);
                                    notify(`Modules replaced successfully for "${newCourses[idx].title}".`);
                                } else {
                                    notify("Error: Array format unknown. Expected list of Modules.", "error");
                                }
                            } 
                            else if (json.modules) {
                                newCourses[idx] = { ...newCourses[idx], ...json, id: targetCourseId }; 
                                setCourses(newCourses);
                                notify(`Course updated: "${newCourses[idx].title}".`);
                            } else {
                                notify("Invalid JSON. Missing 'modules' array.", "error");
                            }
                        }
                    } catch (err) { notify("Error parsing JSON.", "error"); }
                    setTargetCourseId(null);
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            // 3. Import Questions
            const triggerQuestionsImport = (moduleId) => {
                setTargetModuleId(moduleId);
                questionsInputRef.current.click();
            };

            const handleQuestionsImport = (e) => {
                const file = e.target.files[0];
                if (!file || !viewingCourse || !targetModuleId) return;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        if (Array.isArray(json)) {
                            const newCourses = [...courses];
                            const cIdx = newCourses.findIndex(c => c.id === viewingCourse.id);
                            if (cIdx === -1) return;

                            const mIdx = newCourses[cIdx].modules.findIndex(m => m.id === targetModuleId);
                            if (mIdx !== -1) {
                                const existingQ = newCourses[cIdx].modules[mIdx].questions || [];
                                newCourses[cIdx].modules[mIdx].questions = [...existingQ, ...json];
                                
                                setCourses(newCourses);
                                setViewingCourse(newCourses[cIdx]); 
                                notify(`Added ${json.length} questions to module.`);
                            } else notify("Module not found.", "error");
                        } else notify("Invalid format. Expected ARRAY of questions.", "error");
                    } catch(err) { notify("JSON Error.", "error"); }
                    setTargetModuleId(null);
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(courses, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "courses_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                notify("Backup downloaded successfully.");
            };

            const createCourse = (e) => {
                e.preventDefault();
                if(!newCourseId.trim() || !newCourseTitle.trim()) return;
                if(courses.find(c => c.id === newCourseId)) { notify("Course ID already exists.", "error"); return; }
                const newCourse = { id: newCourseId.trim(), title: newCourseTitle.trim(), description: newCourseDesc.trim(), modules: [], hidden: false };
                setCourses([...courses, newCourse]);
                setNewCourseId(''); setNewCourseTitle(''); setNewCourseDesc('');
                notify("New course created! Upload JSON to add content.");
            };

            const updateCourseField = (cId, field, val) => {
                const newCourses = [...courses];
                const idx = newCourses.findIndex(c => c.id === cId);
                if (idx !== -1) {
                    newCourses[idx][field] = val;
                    setCourses(newCourses);
                }
            };

            const deleteCourse = (id) => {
                if (confirm("Delete this course? This cannot be undone.")) {
                    setCourses(courses.filter(c => c.id !== id));
                    notify("Course deleted.");
                }
            };

            const addUser = (e) => {
                e.preventDefault();
                if (newUserName.trim()) { 
                    if (users.find(u => u.name.toLowerCase() === newUserName.trim().toLowerCase())) {
                        notify("User already exists.", "error");
                        return;
                    }
                    setUsers([...users, { name: newUserName.trim(), unlockedCourses: [], access: [] }]); 
                    setNewUserName('');
                    notify("User added successfully.");
                }
            };

            const deleteUser = (idx) => { if (confirm("Delete user?")) { const newU = [...users]; newU.splice(idx, 1); setUsers(newU); notify("User removed."); } };

            // USER EDITING FUNCTIONS
            const startEditingUser = (idx, name) => {
                setEditingUserIdx(idx);
                setEditName(name);
            };

            const saveEditedUser = (idx) => {
                if (!editName.trim()) return;
                const newUsers = [...users];
                newUsers[idx].name = editName.trim();
                setUsers(newUsers);
                setEditingUserIdx(null);
                notify("User renamed successfully.");
            };

            const cancelEditUser = () => {
                setEditingUserIdx(null);
                setEditName("");
            };

            // V16: Granular Permission Toggling
            const toggleMode = (uIdx, cId, mode) => {
                const newUsers = [...users];
                const user = newUsers[uIdx];
                let accessList = Array.isArray(user.access) ? user.access : [];
                const existingAccessIndex = accessList.findIndex(a => a.courseId === cId);
                
                if (existingAccessIndex > -1) {
                    let modes = accessList[existingAccessIndex].modes || [];
                    if (modes.includes(mode)) {
                        modes = modes.filter(m => m !== mode);
                    } else {
                        modes.push(mode);
                    }
                    if (modes.length === 0) {
                        accessList.splice(existingAccessIndex, 1);
                    } else {
                        accessList[existingAccessIndex] = { ...accessList[existingAccessIndex], modes };
                    }
                } else {
                    accessList.push({ courseId: cId, modes: [mode] });
                }
                user.access = accessList;
                setUsers(newUsers);
            };

            const handleGithubPull = async () => {
                if(!ghUrl) return alert("Please enter the Raw GitHub URL.");
                try {
                    const res = await fetch(ghUrl);
                    if(!res.ok) throw new Error("Failed to fetch");
                    const json = await res.json();
                    processImportJson(json);
                    localStorage.setItem(LS_GH_URL, ghUrl); 
                    setShowSyncModal(false);
                } catch(err) {
                    alert("Sync Error: " + err.message + ". Check if the URL is a valid Raw JSON link.");
                }
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {/* MODAL: AI PROMPT HELPER */}
                    {showPromptModal && (
                        <Modal title="AI Content Generation Prompt" onClose={() => setShowPromptModal(false)}>
                            <div className="space-y-4">
                                <p className="text-sm text-slate-500">Copy this prompt and paste it into Gemini, ChatGPT, or Claude along with your source content link/text.</p>
                                <div className="bg-slate-900 text-slate-100 p-4 rounded-lg text-xs font-mono whitespace-pre-wrap overflow-x-auto">
{`Extract the key learning points from the provided content/link and structure it into a valid JSON Array of Modules for a learning app.

The output must be strictly valid JSON. Do not wrap in markdown code blocks if possible, or just give the raw JSON.

Structure Requirements:
[
  {
    "id": 1, 
    "title": "Module Title",
    "questions": [
      {
        "id": 101,
        "question": "Question text here?",
        "options": ["Option A", "Option B", "Option C", "Option D"],
        "answer": 0, // Index of correct option (0-3)
        "explanation": "Detailed explanation of why the answer is correct."
      }
    ]
  }
]`}
                                </div>
                                <button 
                                    onClick={() => {
                                        navigator.clipboard.writeText(`Extract the key learning points from the provided content/link and structure it into a valid JSON Array of Modules for a learning app.

The output must be strictly valid JSON. Do not wrap in markdown code blocks if possible, or just give the raw JSON.

Structure Requirements:
[
  {
    "id": 1, 
    "title": "Module Title",
    "questions": [
      {
        "id": 101,
        "question": "Question text here?",
        "options": ["Option A", "Option B", "Option C", "Option D"],
        "answer": 0, // Index of correct option (0-3)
        "explanation": "Detailed explanation of why the answer is correct."
      }
    ]
  }
]`);
                                        notify("Prompt copied to clipboard!");
                                    }} 
                                    className="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 flex items-center justify-center gap-2"
                                >
                                    <I n="Copy" size={16}/> Copy Prompt
                                </button>
                            </div>
                        </Modal>
                    )}

                    {showSyncModal && (
                        <Modal title="GitHub Cloud Sync" onClose={() => setShowSyncModal(false)}>
                            <div className="space-y-6">
                                <div>
                                    <h4 className="font-bold text-slate-800 flex items-center gap-2 mb-2"><I n="Cloud" size={20}/> Pull from GitHub</h4>
                                    <p className="text-sm text-slate-500 mb-3">Paste the <strong>Raw JSON URL</strong> of your course file to instantly update the app content.</p>
                                    <input 
                                        value={ghUrl} 
                                        onChange={(e) => setGhUrl(e.target.value)} 
                                        placeholder="https://raw.githubusercontent.com/user/repo/main/data.json" 
                                        className="w-full p-2 border rounded mb-2 text-sm"
                                    />
                                    <button onClick={handleGithubPull} className="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Pull Data</button>
                                </div>
                                <hr className="border-slate-200"/>
                                <div>
                                    <h4 className="font-bold text-slate-800 flex items-center gap-2 mb-2"><I n="Upload" size={20}/> Push to GitHub</h4>
                                    <p className="text-sm text-slate-500 mb-3">To update the source file on GitHub, you must upload the JSON manually.</p>
                                    <button onClick={exportData} className="w-full bg-slate-100 text-slate-700 border border-slate-300 py-2 rounded font-bold hover:bg-slate-200 mb-2">1. Download Backup JSON</button>
                                    <a href="https://github.com/login" target="_blank" className="block w-full bg-slate-800 text-white text-center py-2 rounded font-bold hover:bg-slate-900">2. Go to GitHub to Upload</a>
                                </div>
                            </div>
                        </Modal>
                    )}

                    {viewingCourse && (
                        <Modal title={`Inspect: ${viewingCourse.title}`} onClose={() => setViewingCourse(null)}>
                            <div className="space-y-4">
                                <div className="p-4 bg-slate-50 rounded border border-slate-200">
                                    <p className="text-sm text-slate-500"><strong>Description:</strong> {viewingCourse.description}</p>
                                    <p className="text-sm text-slate-500"><strong>ID:</strong> {viewingCourse.id}</p>
                                    <p className="text-sm text-slate-500"><strong>Access Code:</strong> {viewingCourse.code || "None"}</p>
                                </div>
                                <h4 className="font-bold text-slate-800 border-b pb-2 flex justify-between items-center">
                                    <span>Module List</span>
                                    <span className="text-xs font-normal text-slate-400">Click icon to add questions</span>
                                </h4>
                                {viewingCourse.modules.length === 0 ? <p className="text-slate-500 text-sm italic">No modules loaded yet.</p> : (
                                    <div className="space-y-2">
                                        {viewingCourse.modules.map((m, i) => (
                                            <div key={i} className="flex justify-between items-center p-3 bg-white border rounded shadow-sm group">
                                                <div>
                                                    <div className="font-medium text-sm">{m.title}</div>
                                                    <div className="text-xs text-slate-400 mt-1">ID: {m.id}</div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">{m.questions?.length || 0} Qs</span>
                                                    <button onClick={() => triggerQuestionsImport(m.id)} className="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition-colors" title="Import Questions to this Module">
                                                        <I n="FilePlus" size={18}/>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </Modal>
                    )}

                    <div className="w-64 bg-slate-900 text-white flex flex-col shrink-0">
                        <div className="p-6 border-b border-slate-800"><h1 className="text-xl font-bold flex items-center gap-2"><I n="Settings"/> Admin Panel</h1></div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={() => setActiveTab('courses')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${activeTab === 'courses' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}><I n="Library"/> Manage Courses</button>
                            <button onClick={() => setActiveTab('users')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${activeTab === 'users' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}><I n="User"/> Manage Users</button>
                            <button onClick={() => setActiveTab('settings')} className={`w-full text-left p-3 rounded flex items-center gap-3 ${activeTab === 'settings' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}><I n="Shield"/> Security</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800"><button onClick={onLogout} className="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-white p-2"><I n="LogOut"/> Logout</button></div>
                        <div className="p-2 text-center text-xs text-slate-600 border-t border-slate-800">
                            &copy; {new Date().getFullYear()} Ramprasad NS
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8 flex flex-col">
                        <div className="flex-1">
                        {activeTab === 'courses' && (
                            <div className="max-w-4xl mx-auto space-y-8">
                                <input type="file" ref={bulkInputRef} onChange={handleBulkImport} className="hidden" accept=".json"/>
                                <input type="file" ref={singleInputRef} onChange={handleSingleImport} className="hidden" accept=".json"/>
                                <input type="file" ref={questionsInputRef} onChange={handleQuestionsImport} className="hidden" accept=".json"/>

                                <div className="flex justify-between items-end border-b border-slate-200 pb-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-slate-800">Course Library</h2>
                                        <p className="text-slate-500 text-sm">Create, edit, or remove courses.</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowSyncModal(true)} className="bg-slate-800 text-white px-4 py-2 rounded shadow hover:bg-slate-900 flex items-center gap-2 text-sm font-medium transition-colors"><I n="Cloud" size={16}/> GitHub Sync</button>
                                        <button onClick={() => setShowPromptModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 flex items-center gap-2 text-sm font-medium transition-colors"><I n="HelpCircle" size={16}/> AI Prompt</button>
                                        <button onClick={exportData} className="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded shadow-sm hover:bg-slate-50 flex items-center gap-2 text-sm font-medium transition-colors"><I n="Download" size={16}/> Backup</button>
                                        <button onClick={() => bulkInputRef.current.click()} className="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 flex items-center gap-2 text-sm font-medium transition-colors"><I n="Upload" size={16}/> Import</button>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800"><I n="Plus"/> Create New Course</h2>
                                    <form onSubmit={createCourse} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <input value={newCourseTitle} onChange={e => setNewCourseTitle(e.target.value)} placeholder="Course Title" className="p-2 border rounded" required />
                                        <input value={newCourseId} onChange={e => setNewCourseId(e.target.value)} placeholder="Unique ID (e.g. test-course)" className="p-2 border rounded" required />
                                        <input value={newCourseDesc} onChange={e => setNewCourseDesc(e.target.value)} placeholder="Description" className="p-2 border rounded md:col-span-2" />
                                        <button type="submit" className="md:col-span-2 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Add Course</button>
                                    </form>
                                </div>

                                <div className="grid gap-4">
                                    {courses.map(c => (
                                        <div key={c.id} className="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center hover:border-blue-300 transition-colors gap-4">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h3 className="font-bold text-lg">{c.title}</h3>
                                                    {c.hidden && <span className="bg-slate-100 text-slate-500 text-xs px-2 py-0.5 rounded flex items-center gap-1 border border-slate-200"><I n="EyeOff" size={12}/> Hidden</span>}
                                                </div>
                                                <div className="flex items-center gap-4 text-sm text-slate-500 mb-2">
                                                    <span>ID: <code className="bg-slate-100 px-1 rounded text-xs">{c.id}</code></span>
                                                    <span className="flex items-center gap-1"><I n="Library" size={14}/> {c.modules ? c.modules.length : 0} Modules</span>
                                                </div>
                                                <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center text-xs">
                                                    <div className="flex items-center gap-2">
                                                        <I n="Key" size={14} className="text-slate-400"/>
                                                        <input 
                                                            value={c.code || ''} 
                                                            onChange={(e) => updateCourseField(c.id, 'code', e.target.value)} 
                                                            placeholder="Set Access Code" 
                                                            className="border-b border-slate-200 focus:border-blue-500 outline-none text-slate-600 w-32 bg-transparent"
                                                        />
                                                    </div>
                                                    <label className="flex items-center gap-2 cursor-pointer text-slate-500 hover:text-slate-700">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={c.hidden || false} 
                                                            onChange={(e) => updateCourseField(c.id, 'hidden', e.target.checked)} 
                                                            className="accent-slate-600"
                                                        />
                                                        <span>Hide from List</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 items-center self-end sm:self-center">
                                                <button onClick={() => setViewingCourse(c)} className="text-slate-600 hover:bg-slate-100 p-2 rounded-full" title="Inspect Content"><I n="Eye"/></button>
                                                <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                                <button onClick={() => triggerSingleImport(c.id)} className="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded flex items-center gap-2 text-sm border border-blue-200" title="Update JSON for this course"><I n="UpdateDoc" size={16}/> Update</button>
                                                <button onClick={() => deleteCourse(c.id)} className="text-red-500 hover:bg-red-50 p-2 rounded" title="Delete"><I n="Trash"/></button>
                                            </div>
                                        </div>
                                    ))}
                                    {courses.length === 0 && <p className="text-slate-500 text-center py-10 bg-slate-50 rounded-xl border border-dashed border-slate-300">No courses loaded. Add one manually or Import JSON.</p>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'users' && (
                            <div className="max-w-4xl mx-auto space-y-8">
                                <h2 className="text-2xl font-bold text-slate-800 mb-6">Registered Users</h2>
                                <p className="text-sm text-slate-500 mb-6">These accounts are stored locally on this device.</p>
                                <div className="space-y-6">
                                    {users.map((u, idx) => (
                                        <div key={idx} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-4">
                                            <div className="flex justify-between items-center border-b pb-4">
                                                <div className="flex items-center gap-2 flex-1">
                                                    <div className="bg-slate-100 p-2 rounded-full"><I n="User" size={20}/></div>
                                                    
                                                    {editingUserIdx === idx ? (
                                                        <div className="flex items-center gap-2 flex-1">
                                                            <input 
                                                                value={editName}
                                                                onChange={(e) => setEditName(e.target.value)}
                                                                className="p-1 border rounded"
                                                                autoFocus
                                                            />
                                                            <button onClick={() => saveEditedUser(idx)} className="text-green-600 text-xs px-2 py-1 border border-green-200 rounded hover:bg-green-50">Save</button>
                                                            <button onClick={cancelEditUser} className="text-slate-400 text-xs px-2 py-1 hover:text-slate-600">Cancel</button>
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            <h3 className="font-bold text-lg flex items-center gap-2">
                                                                {u.name}
                                                                <button onClick={() => startEditingUser(idx, u.name)} className="text-slate-300 hover:text-blue-500"><I n="Edit" size={14}/></button>
                                                            </h3>
                                                            <p className="text-xs text-slate-400">Local Account</p>
                                                        </div>
                                                    )}
                                                </div>
                                                <button onClick={() => deleteUser(idx)} className="text-red-500 text-sm hover:underline ml-4">Remove User</button>
                                            </div>
                                            
                                            {/* V16: Granular Access Controls */}
                                            <div className="grid grid-cols-1 gap-2">
                                                {courses.map(c => {
                                                    const accessObj = u.access?.find(a => a.courseId === c.id) || {};
                                                    const modes = accessObj.modes || [];
                                                    const hasStudy = modes.includes('study');
                                                    const hasQuiz = modes.includes('quiz');
                                                    const hasAny = modes.length > 0;
                                                    const isUnlockedByCode = u.unlockedCourses?.includes(c.id);

                                                    return (
                                                        <div key={c.id} className={`flex items-center justify-between p-3 rounded border transition-colors ${hasAny || isUnlockedByCode ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-100'}`}>
                                                            <div className="flex flex-col">
                                                                <span className="font-medium text-sm">{c.title}</span>
                                                                {isUnlockedByCode && <span className="text-xs text-green-600 font-bold flex items-center gap-1"><I n="Check" size={10}/> Code Unlocked</span>}
                                                            </div>
                                                            <div className="flex gap-4 items-center">
                                                                <label className="flex items-center gap-2 cursor-pointer">
                                                                    <input type="checkbox" checked={hasStudy} onChange={() => toggleMode(idx, c.id, 'study')} className="accent-blue-600"/>
                                                                    <span className="text-xs font-bold text-slate-600 uppercase">Study</span>
                                                                </label>
                                                                <label className="flex items-center gap-2 cursor-pointer">
                                                                    <input type="checkbox" checked={hasQuiz} onChange={() => toggleMode(idx, c.id, 'quiz')} className="accent-emerald-600"/>
                                                                    <span className="text-xs font-bold text-slate-600 uppercase">Quiz</span>
                                                                </label>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {courses.length === 0 && <span className="text-sm text-slate-400 italic">No courses available.</span>}
                                            </div>
                                        </div>
                                    ))}
                                    {users.length === 0 && <p className="text-slate-500">No users registered on this device.</p>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="max-w-xl mx-auto space-y-8 animate-fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">Admin Security Settings</h2>
                                
                                <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                                    <div className="flex items-center gap-4 mb-6">
                                        <div className="bg-slate-100 p-3 rounded-full"><I n="Shield" size={32} className="text-blue-600"/></div>
                                        <div>
                                            <h3 className="font-bold text-lg">Update Credentials</h3>
                                            <p className="text-xs text-slate-500">Change your admin username and password.</p>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase block mb-1">New Username</label>
                                            <input value={adminUser} onChange={e => setAdminUser(e.target.value)} className="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase block mb-1">New Password</label>
                                            <input type="password" value={adminPass} onChange={e => setAdminPass(e.target.value)} className="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Recovery Email</label>
                                            <div className="flex gap-2">
                                                <div className="p-3 bg-slate-50 border border-r-0 rounded-l text-slate-400"><I n="Mail" size={18}/></div>
                                                <input value={adminEmail} onChange={e => setAdminEmail(e.target.value)} placeholder="your@email.com" className="w-full p-3 border rounded-r focus:ring-2 focus:ring-blue-500 outline-none" />
                                            </div>
                                            <p className="text-[10px] text-slate-400 mt-1">Used to recover access if you forget your password.</p>
                                        </div>
                                        <button onClick={saveAdminSettings} className="w-full bg-slate-900 text-white py-3 rounded font-bold hover:bg-slate-800 mt-2">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        </div>
                        <Footer />
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const QuizApp = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [courses, setCourses] = useState([]);
            const [users, setUsers] = useState([]);
            
            // ADMIN CREDS STATE
            const [adminCreds, setAdminCreds] = useState(DEFAULT_ADMIN);
            
            const [activeCourseId, setActiveCourseId] = useState(null);
            const [activeModuleId, setActiveModuleId] = useState(null);
            const [viewMode, setViewMode] = useState('study');
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [score, setScore] = useState(0);
            const [history, setHistory] = useState([]);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [timer, setTimer] = useState(0);
            const [timeSpent, setTimeSpent] = useState(0);
            const [timerActive, setTimerActive] = useState(false);
            const [unlockCodeInput, setUnlockCodeInput] = useState("");
            
            // v14: Redeem Modal State
            const [showRedeemModal, setShowRedeemModal] = useState(false);
            const [redeemCodeInput, setRedeemCodeInput] = useState("");

            useEffect(() => {
                try {
                    const loadedCourses = JSON.parse(localStorage.getItem(LS_COURSES)) || sampleCourses;
                    let loadedUsers = JSON.parse(localStorage.getItem(LS_USERS)) || [];
                    const loadedAdmin = JSON.parse(localStorage.getItem(LS_ADMIN_CREDS)) || DEFAULT_ADMIN;
                    
                    if (!Array.isArray(loadedUsers)) loadedUsers = [];
                    setCourses(loadedCourses);
                    setUsers(loadedUsers);
                    setAdminCreds(loadedAdmin);

                    const active = localStorage.getItem(LS_ACTIVE_USER);
                    if (active) {
                        if (active === 'admin') { setIsAdmin(true); setUser('Admin'); } 
                        else {
                            const validUser = loadedUsers.find(u => u.name === active);
                            if (validUser) setUser(validUser); else localStorage.removeItem(LS_ACTIVE_USER);
                        }
                    }
                } catch (e) {
                    setCourses(sampleCourses);
                    setUsers([]);
                }
            }, []);

            useEffect(() => { localStorage.setItem(LS_COURSES, JSON.stringify(courses)); }, [courses]);
            useEffect(() => { localStorage.setItem(LS_USERS, JSON.stringify(users)); }, [users]);
            useEffect(() => { if (user && !isAdmin) { const h = localStorage.getItem(`prep_history_${user.name}`); setHistory(h ? JSON.parse(h) : []); } }, [user, isAdmin]);

            useEffect(() => {
                let interval;
                if (timerActive) {
                    interval = setInterval(() => {
                        setTimer(t => {
                            if (t <= 1) {
                                clearInterval(interval);
                                setTimerActive(false);
                                setShowResult(true);
                                saveResult(score, activeModule?.questions.length, timeSpent + 1);
                                return 0;
                            }
                            return t - 1;
                        });
                        setTimeSpent(ts => ts + 1);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [timerActive, score, activeModule, timeSpent]); 

            // v16: Hybrid Permission Logic (Admin Checkboxes OR Code Unlock)
            const getPermissions = (cId) => {
                if (isAdmin) return { canStudy: true, canQuiz: true };
                
                // 1. Check Granular Access (Admin Checkboxes)
                const accessObj = user?.access?.find(a => a.courseId === cId) || {};
                const modes = accessObj.modes || [];
                const adminGrantedStudy = modes.includes('study');
                const adminGrantedQuiz = modes.includes('quiz');

                // 2. Check Global Unlock (Code Redeem)
                const codeUnlocked = user?.unlockedCourses && user.unlockedCourses.includes(cId);
                
                // 3. Check Default (No Code Required)
                const course = courses.find(c => c.id === cId);
                const isPublic = !course?.code;

                return {
                    canStudy: adminGrantedStudy || codeUnlocked || isPublic,
                    canQuiz: adminGrantedQuiz || codeUnlocked || isPublic
                };
            };

            const isCourseVisible = (cId) => {
                if (isAdmin) return true;
                const c = courses.find(c => c.id === cId);
                // Visible if NOT hidden OR if ANY permission exists
                const perms = getPermissions(cId);
                return !c.hidden || perms.canStudy || perms.canQuiz;
            };

            const visibleCourses = courses.filter(c => isCourseVisible(c.id));

            const activeCourse = courses.find(c => c.id === activeCourseId);
            const activeModule = activeCourse?.modules.find(m => m.id === activeModuleId);
            const currentQuestion = activeModule?.questions[currentQuestionIndex];
            
            // Get perms for active course
            const perms = activeCourseId ? getPermissions(activeCourseId) : { canStudy: false, canQuiz: false };
            const isFullyLocked = !perms.canStudy && !perms.canQuiz; // If neither is allowed, show lock screen

            const unlockCourse = (inputCode) => {
                // v14: Unlock Logic (also used for Redeem)
                const targetCourse = activeCourse || courses.find(c => c.code && c.code.toLowerCase() === inputCode.trim().toLowerCase());
                
                if (targetCourse && inputCode.trim().toLowerCase() === targetCourse.code.toLowerCase()) {
                    const updatedUsers = users.map(u => {
                        if (u.name === user.name) {
                            const unlocked = u.unlockedCourses || [];
                            if (!unlocked.includes(targetCourse.id)) return { ...u, unlockedCourses: [...unlocked, targetCourse.id] };
                        }
                        return u;
                    });
                    setUsers(updatedUsers);
                    setUser(updatedUsers.find(u => u.name === user.name));
                    setUnlockCodeInput("");
                    setRedeemCodeInput("");
                    setShowRedeemModal(false);
                    alert(`Course "${targetCourse.title}" Unlocked!`);
                } else {
                    alert("Incorrect Access Code.");
                }
            };

            const login = (name, pass) => {
                // Check against dynamic admin creds
                if (name === adminCreds.user && pass === adminCreds.pass) { 
                    setUser('Admin'); 
                    setIsAdmin(true); 
                    localStorage.setItem(LS_ACTIVE_USER, 'admin'); 
                } 
                else {
                    const found = users.find(u => u.name.toLowerCase() === name.toLowerCase());
                    if (found) { setUser(found); setIsAdmin(false); localStorage.setItem(LS_ACTIVE_USER, found.name); } 
                    else alert("User not found. Please create an account.");
                }
            };

            const forgotPass = () => {
                const email = prompt("Enter your Recovery Email:");
                if (email && email.toLowerCase() === adminCreds.email.toLowerCase()) {
                    alert(`Your credentials are:\nUser: ${adminCreds.user}\nPass: ${adminCreds.pass}`);
                } else {
                    alert("Email not recognized or not set.");
                }
            };

            const signup = (name) => {
                if (!name.trim()) return;
                if (name.toLowerCase() === 'admin') { alert("Cannot use reserved name."); return; }
                if (users.find(u => u.name.toLowerCase() === name.toLowerCase())) { alert("User already exists. Please login."); return; }
                
                const newUser = { name: name.trim(), unlockedCourses: [], access: [] };
                const newUsers = [...users, newUser];
                setUsers(newUsers);
                setUser(newUser);
                localStorage.setItem(LS_ACTIVE_USER, newUser.name);
            };

            const logout = () => { setUser(null); setIsAdmin(false); setActiveCourseId(null); setActiveModuleId(null); localStorage.removeItem(LS_ACTIVE_USER); };

            const saveResult = (s, t, totalTime = timeSpent) => {
                if(isAdmin) return;
                const entry = { course: activeCourse.title, module: activeModule.title, score: s, total: t, time: totalTime, date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString() };
                const newH = [entry, ...history];
                setHistory(newH);
                localStorage.setItem(`prep_history_${user.name}`, JSON.stringify(newH));
            };

            const clearHistory = () => {
                if(confirm("Clear all your history logs?")) {
                    setHistory([]);
                    localStorage.removeItem(`prep_history_${user.name}`);
                }
            };

            const handleAnswer = (idx) => {
                if (selectedAnswer !== null) return;
                setSelectedAnswer(idx);
                if (viewMode === 'quiz' && idx === currentQuestion.answer) setScore(s => s + 1);
            };

            const nextQuestion = () => {
                if (currentQuestionIndex < activeModule.questions.length - 1) { setCurrentQuestionIndex(i => i + 1); setSelectedAnswer(null); } 
                else { 
                    if (viewMode === 'quiz') saveResult(score, activeModule.questions.length); 
                    setShowResult(true); 
                    setTimerActive(false); 
                }
            };

            const startModule = (mode) => {
                const currentPerms = getPermissions(activeCourseId);
                if (mode === 'study' && !currentPerms.canStudy) { alert("Access Denied: Study Mode is disabled for you."); return; }
                if (mode === 'quiz' && !currentPerms.canQuiz) { alert("Access Denied: Quiz Mode is disabled for you."); return; }

                setViewMode(mode);
                setCurrentQuestionIndex(0);
                setSelectedAnswer(null);
                setScore(0);
                setShowResult(false);
                setTimeSpent(0);
                
                if (mode === 'quiz') {
                    const totalTime = activeModule.questions.length * TIME_PER_QUESTION; 
                    setTimer(totalTime);
                    setTimerActive(true);
                } else {
                    setTimer(0);
                    setTimerActive(false);
                }
            };

            const resetAppData = () => {
                if(confirm("EMERGENCY RESET: This will delete all users and courses stored in this browser to fix the crash. Continue?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            if (!user) return (
                <div>
                    <LoginScreen onLogin={login} onSignup={signup} onForgotPass={forgotPass} />
                    <button onClick={resetAppData} className="fixed bottom-4 right-4 text-xs text-slate-300 hover:text-red-500">Reset App Data</button>
                    <div className="fixed bottom-10 w-full text-center p-4 text-xs text-slate-400">
                        &copy; {new Date().getFullYear()} Ramprasad NS. All rights reserved.
                    </div>
                </div>
            );
            
            if (isAdmin) return <AdminPanel courses={courses} setCourses={setCourses} users={users} setUsers={setUsers} onLogout={logout} />;

            const progress = activeModule ? ((currentQuestionIndex + (showResult ? 1 : 0)) / activeModule.questions.length) * 100 : 0;

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
                    {/* REDEEM MODAL */}
                    {showRedeemModal && (
                        <Modal title="Redeem Course Access" onClose={() => setShowRedeemModal(false)}>
                            <div className="space-y-4">
                                <p className="text-sm text-slate-600">Enter the access code provided by your instructor to reveal and unlock your course.</p>
                                <input 
                                    value={redeemCodeInput} 
                                    onChange={(e) => setRedeemCodeInput(e.target.value)} 
                                    placeholder="Enter Access Code" 
                                    className="w-full p-3 border rounded font-mono text-center tracking-widest text-lg uppercase"
                                />
                                <button onClick={() => unlockCourse(redeemCodeInput)} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Verify & Add Course</button>
                            </div>
                        </Modal>
                    )}

                    <div className={`fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-slate-200 transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
                        <div className="p-5 border-b border-slate-100 bg-slate-900 text-white shrink-0">
                            <div className="flex justify-between items-start">
                                <div><h1 className="font-bold text-lg">Prep App</h1><p className="text-xs text-slate-400 mt-1">{user.name}</p></div>
                                <button onClick={logout}><I n="LogOut" size={18}/></button>
                            </div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden absolute top-5 right-5 text-white"><I n="X"/></button>
                        </div>
                        <div className="overflow-y-auto flex-1 p-2">
                            {/* SIDEBAR NAVIGATION */}
                            <div className="px-3 py-2 flex justify-between items-center text-xs font-bold text-slate-400 uppercase">
                                <span>My Courses</span>
                                <button onClick={() => setShowRedeemModal(true)} className="text-blue-600 hover:text-blue-800 flex items-center gap-1"><I n="Plus" size={12}/> Redeem</button>
                            </div>
                            
                            <div className="mb-4 px-3">
                                <button onClick={() => document.getElementById('student-import').click()} className="w-full py-2 border border-dashed border-slate-300 rounded text-xs text-slate-500 hover:border-blue-500 hover:text-blue-500 flex items-center justify-center gap-2">
                                    <I n="Upload" size={14}/> Import Data File
                                </button>
                                <input 
                                    id="student-import" 
                                    type="file" 
                                    className="hidden" 
                                    accept=".json"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if(!file) return;
                                        const reader = new FileReader();
                                        reader.onload = (ev) => {
                                            try {
                                                const json = JSON.parse(ev.target.result);
                                                const newCourses = [...courses];
                                                const toAdd = Array.isArray(json) ? json : (json.modules ? [json] : []);
                                                toAdd.forEach(c => {
                                                    if (!c.id) return;
                                                    const idx = newCourses.findIndex(ex => ex.id === c.id);
                                                    if (idx === -1) newCourses.push(c);
                                                    else newCourses[idx] = c;
                                                });
                                                setCourses(newCourses);
                                                alert("Courses Updated. Use 'Redeem' to unlock hidden content.");
                                            } catch(err) { alert("Invalid File"); }
                                            e.target.value = '';
                                        };
                                        reader.readAsText(file);
                                    }}
                                />
                            </div>

                            {visibleCourses.map(c => {
                                const cPerms = getPermissions(c.id);
                                const unlocked = cPerms.canStudy || cPerms.canQuiz;
                                const isActive = activeCourseId === c.id;
                                return (
                                    <div key={c.id} className="mb-1">
                                        <button onClick={() => { setActiveCourseId(c.id); setActiveModuleId(null); }} className={`w-full text-left p-3 rounded-lg flex items-center gap-2 transition-colors ${isActive ? 'bg-slate-100' : 'hover:bg-slate-50'}`}>
                                            <div className={`p-1.5 rounded-md ${isActive ? 'bg-blue-600 text-white' : (unlocked ? 'bg-blue-100 text-blue-600' : 'bg-slate-200 text-slate-500')}`}>
                                                <I n={unlocked ? 'BookOpen' : 'Lock'} size={16}/>
                                            </div>
                                            <span className={`text-sm font-medium truncate flex-1 ${isActive ? 'text-slate-900' : 'text-slate-700'}`}>{c.title}</span>
                                        </button>
                                        
                                        {/* MODULE LIST (Only show if Active AND Unlocked) */}
                                        {isActive && unlocked && c.modules && (
                                            <div className="pl-4 mt-1 space-y-1 border-l-2 border-slate-100 ml-3">
                                                {c.modules.map(m => {
                                                    const isCompleted = history.some(h => h.course === c.title && h.module === m.title && (h.score / h.total) >= 0.7);
                                                    return (
                                                        <button key={m.id} onClick={() => { setActiveModuleId(m.id); startModule('study'); }} className={`w-full text-left p-2 pl-3 rounded-r-lg text-xs flex items-center justify-between gap-2 ${activeModuleId === m.id ? 'bg-blue-50 text-blue-700 font-bold border-l-2 border-blue-600' : 'text-slate-500 hover:bg-slate-50'}`}>
                                                            <span className="truncate">{m.title.replace(/^Module \d+: /, '')}</span>
                                                            {isCompleted && <I n="Check" size={14} className="text-green-500" />}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {visibleCourses.length === 0 && <div className="p-4 text-sm text-slate-500 text-center">No visible courses.</div>}
                        </div>
                        <div className="p-2 text-center text-xs text-slate-600 border-t border-slate-200">
                            &copy; {new Date().getFullYear()} Ramprasad NS
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        <div className="md:hidden p-4 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm z-10 shrink-0">
                            <button onClick={() => setSidebarOpen(true)}><I n="Menu"/></button>
                            <span className="font-semibold">Dashboard</span>
                            <button onClick={() => { setActiveCourseId(null); setActiveModuleId(null); }}><I n="Home"/></button>
                        </div>

                        <div className="flex-1 overflow-y-auto bg-slate-50 p-6 flex flex-col">
                            <div className="flex-1">
                            {!activeCourseId && (
                                <div className="max-w-5xl mx-auto animate-fade-in flex flex-col items-center justify-center h-full text-center">
                                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 max-w-lg">
                                        <div className="bg-blue-50 text-blue-600 p-4 rounded-full inline-block mb-4"><I n="BookOpen" size={48}/></div>
                                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Welcome to Prep App</h2>
                                        <p className="text-slate-500 mb-6">Select a course to begin.</p>
                                        <button onClick={() => setShowRedeemModal(true)} className="bg-slate-900 text-white px-6 py-3 rounded-full font-bold hover:bg-slate-800 flex items-center gap-2 mx-auto">
                                            <I n="Key"/> Redeem Course Code
                                        </button>
                                    </div>
                                </div>
                            )}

                            {activeCourseId && isFullyLocked && (
                                <div className="max-w-xl mx-auto animate-fade-in mt-10">
                                    <div className="bg-white p-10 rounded-2xl shadow-lg border border-slate-200 text-center">
                                        <div className="bg-slate-100 text-slate-400 p-6 rounded-full inline-block mb-6"><I n="Lock" size={48}/></div>
                                        <h2 className="text-2xl font-bold text-slate-800 mb-2">{activeCourse.title}</h2>
                                        <p className="text-slate-500 mb-8">This course is protected. Please enter the Access Code provided by your instructor to view the contents.</p>
                                        
                                        <div className="flex gap-2">
                                            <input 
                                                value={unlockCodeInput} 
                                                onChange={(e) => setUnlockCodeInput(e.target.value)} 
                                                placeholder="Enter Access Code" 
                                                className="flex-1 p-3 border rounded-lg font-mono text-center tracking-widest text-lg uppercase focus:ring-2 focus:ring-blue-500 outline-none"
                                            />
                                            <button onClick={() => unlockCourse(unlockCodeInput)} className="bg-blue-600 text-white px-6 rounded-lg font-bold hover:bg-blue-700">Unlock</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeCourseId && !isFullyLocked && !activeModuleId && (
                                <div className="text-center py-10 animate-fade-in">
                                    <div className="inline-block p-3 bg-blue-100 text-blue-600 rounded-xl mb-4"><I n="BookOpen" size={32}/></div>
                                    <h2 className="text-3xl font-bold mb-2 text-slate-800">{activeCourse.title}</h2>
                                    <p className="text-slate-500 mb-8 max-w-2xl mx-auto">{activeCourse.description || "Select a module from the sidebar to start studying."}</p>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="text-4xl font-bold text-blue-600 mb-1">{activeCourse.modules.length}</div>
                                            <div className="text-xs font-bold text-slate-400 uppercase">Modules</div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="text-4xl font-bold text-emerald-600 mb-1">
                                                {activeCourse.modules.reduce((acc, m) => acc + m.questions.length, 0)}
                                            </div>
                                            <div className="text-xs font-bold text-slate-400 uppercase">Questions</div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="text-4xl font-bold text-purple-600 mb-1">
                                                {history.filter(h => h.course === activeCourse.title && (h.score/h.total) >= 0.7).length}
                                            </div>
                                            <div className="text-xs font-bold text-slate-400 uppercase">Completed</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeModuleId && currentQuestion && !isFullyLocked && (
                                <div className="max-w-3xl mx-auto animate-fade-in">
                                    <div className="flex justify-between items-center mb-6">
                                        <div><div className="text-xs uppercase text-slate-400 font-bold">Module</div><h2 className="text-xl font-bold">{activeModule.title}</h2></div>
                                        <div className="flex gap-4 items-center">
                                            {viewMode === 'quiz' && (
                                                <div className={`px-3 py-1 rounded font-mono text-sm flex items-center gap-2 ${timer < 60 ? 'bg-red-100 text-red-700 font-bold' : 'bg-slate-900 text-white'}`}><I n="Clock" size={14}/> {formatTime(timer)}</div>
                                            )}
                                            <div className="bg-white border rounded p-1 flex">
                                                {perms.canStudy ? (
                                                    <button onClick={() => startModule('study')} className={`px-3 py-1 rounded text-sm font-medium ${viewMode==='study'?'bg-blue-100 text-blue-700':'text-slate-500'}`}>Study</button>
                                                ) : (
                                                    <button className="px-3 py-1 rounded text-sm font-medium text-slate-400 flex items-center gap-1 cursor-not-allowed"><I n="Lock" size={12}/> Study</button>
                                                )}
                                                
                                                {perms.canQuiz ? (
                                                    <button onClick={() => startModule('quiz')} className={`px-3 py-1 rounded text-sm font-medium ${viewMode==='quiz'?'bg-emerald-100 text-emerald-700':'text-slate-500'}`}>Quiz</button>
                                                ) : (
                                                    <button onClick={() => setUnlockModalCourse(activeCourse)} className="px-3 py-1 rounded text-sm font-medium text-slate-400 flex items-center gap-1"><I n="Lock" size={12}/> Quiz</button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="w-full bg-slate-200 rounded-full h-2 mb-6 overflow-hidden">
                                        <div className="bg-blue-600 h-2 rounded-full progress-bar-transition" style={{ width: `${progress}%` }}></div>
                                    </div>

                                    {!showResult ? (
                                        <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                                            <div className="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between text-xs font-bold text-slate-500 uppercase"><span>Question {currentQuestionIndex + 1} / {activeModule.questions.length}</span>{viewMode === 'quiz' && <span>Score: {score}</span>}</div>
                                            <div className="p-8">
                                                <h3 className="text-xl font-bold mb-6">{currentQuestion.question}</h3>
                                                <div className="space-y-3">
                                                    {viewMode === 'study' ? (
                                                        <div className="bg-green-50 border border-green-200 p-4 rounded text-green-900 font-medium flex gap-2"><I n="CheckCircle" className="shrink-0"/> {currentQuestion.options[currentQuestion.answer]}</div>
                                                    ) : (
                                                        currentQuestion.options.map((opt, idx) => {
                                                            let cls = "border hover:border-blue-400 hover:bg-blue-50";
                                                            let icon = null;
                                                            if (selectedAnswer !== null) {
                                                                if (idx === currentQuestion.answer) { cls = "bg-green-50 border-green-500 text-green-900"; icon = <I n="CheckCircle" className="text-green-600"/>; }
                                                                else if (idx === selectedAnswer) { cls = "bg-red-50 border-red-500 text-red-900"; icon = <I n="XCircle" className="text-red-600"/>; }
                                                                else cls = "opacity-50 cursor-not-allowed";
                                                            }
                                                            return <button key={idx} onClick={() => handleAnswer(idx)} disabled={selectedAnswer !== null} className={`w-full text-left p-4 rounded border-slate-200 flex justify-between items-center transition-all ${cls}`}><span>{opt}</span>{icon}</button>
                                                        })
                                                    )}
                                                </div>
                                            </div>
                                            {(viewMode === 'study' || selectedAnswer !== null) && (
                                                <div className="bg-slate-50 p-6 border-t border-slate-100">
                                                    <div className="mb-6 text-sm text-slate-700 bg-white p-4 rounded border border-slate-200"><strong>Explanation:</strong> {currentQuestion.explanation}</div>
                                                    <div className="flex justify-end"><button onClick={nextQuestion} className="bg-slate-900 text-white px-6 py-2 rounded font-bold hover:bg-slate-700 flex items-center gap-2">{currentQuestionIndex < activeModule.questions.length - 1 ? 'Next' : 'Finish'} <I n="ChevronRight"/></button></div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 bg-white rounded-xl shadow border border-slate-100">
                                            <div className="inline-block p-4 bg-green-100 text-green-600 rounded-full mb-4"><I n="Award" size={40}/></div>
                                            <h2 className="text-2xl font-bold mb-2">Module Complete!</h2>
                                            {viewMode === 'quiz' && (
                                                <div className="mb-6">
                                                    <p className="text-3xl font-bold text-slate-800">{score} / {activeModule.questions.length}</p>
                                                    <p className="text-sm text-slate-500">Time Taken: {formatTime(timeSpent)}</p>
                                                </div>
                                            )}
                                            <div className="flex justify-center gap-4">
                                                <button onClick={() => { setActiveCourseId(null); setActiveModuleId(null); }} className="px-4 py-2 border rounded hover:bg-slate-50">Dashboard</button>
                                                <button onClick={() => startModule(viewMode)} className="px-4 py-2 bg-slate-900 text-white rounded hover:bg-slate-700">Retry</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            </div>
                            <Footer />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuizApp />);
    </script>
</body>
</html>
